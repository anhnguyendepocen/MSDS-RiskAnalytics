---
title: ''
mainfont: Arial
fontsize: 12pt
documentclass: report
header-includes:
- \PassOptionsToPackage{table}{xcolor}
- \usepackage{caption}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage[table]{xcolor}
- \usepackage{fancyhdr}
- \usepackage{boldline}
- \usepackage{tipa}
   \definecolor{headergrey}{HTML}{545454}
   \definecolor{msdblue}{HTML}{1C93D1}
   \pagestyle{fancy}
   \setlength\headheight{30pt}
   \rhead{\color{headergrey}\today}
   \fancyhead[L]{\color{headergrey}Moretz, Brandon}
   \fancyhead[C]{\Large\bfseries\color{headergrey} Stock Returns and Lognormal Distributions}
   \rfoot{\color{headergrey}Module 2}
   \lfoot{\color{headergrey}MSDS 451}
   \fancyfoot[C]{\rmfamily\color{headergrey}Financial and Risk Analytics}
geometry: left = 1cm, right = 1cm, top = 2cm, bottom = 3cm
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
  html_document:
    df_print: paged
---


```{r knitr_setup, include = FALSE}

# DO NOT ADD OR REVISE CODE HERE
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, dev = 'png')
options(knitr.table.format = "latex")

```

```{r report_setup, message = FALSE, warning = FALSE, include = FALSE}

library(data.table, quietly = TRUE, warn.conflicts = FALSE)

assignInNamespace("cedta.pkgEvalsUserCode", c(data.table:::cedta.pkgEvalsUserCode, "rtvs"), "data.table")

library(ggplot2, quietly = TRUE, warn.conflicts = FALSE)
library(ggrepel, quietly = TRUE, warn.conflicts = FALSE)
library(ggthemes, quietly = TRUE, warn.conflicts = FALSE)
library(knitr, quietly = TRUE, warn.conflicts = FALSE)
library(kableExtra, quietly = TRUE, warn.conflicts = FALSE)
library(Rblpapi, quietly = TRUE, warn.conflicts = FALSE)
library(scales, quietly = TRUE, warn.conflicts = FALSE)
library(pander, quietly = TRUE, warn.conflicts = FALSE)
library(dplyr, quietly = TRUE, warn.conflicts = FALSE)
library(formattable, quietly = TRUE, warn.conflicts = FALSE)
library(grid, quietly = TRUE, warn.conflicts = FALSE)
library(gridExtra, quietly = TRUE, warn.conflicts = FALSE)
library(png, quietly = TRUE, warn.conflicts = FALSE)
library(extrafont, quietly = TRUE, warn.conflicts = FALSE)
library(tinytex, quietly = TRUE, warn.conflicts = FALSE)
library(stringr, quietly = TRUE, warn.conflicts = FALSE)
library(lubridate, quietly = TRUE, warn.conflicts = FALSE)
library(reshape2, quietly = TRUE, warn.conflicts = FALSE)
library(ggrepel, quietly = TRUE, warn.conflicts = FALSE)

options(tinytex.verbose = TRUE)
suppressMessages(library("tidyverse"))

pretty_kable <- function(data, title, dig = 2) {
  kable(data, caption = title, digits = dig) %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
}

theme_set(theme_light())

# Theme Overrides
theme_update(plot.title = element_text(hjust = 0.5),
             axis.text.x = element_text(size = 10),
             axis.text.y = element_text(size = 10),
             axis.title = element_text(face = "bold", size = 12, colour = "steelblue4"),
             legend.position = "top", legend.title = element_blank())

```

```{r pander_setup, include = FALSE}

panderOptions('table.alignment.default', function(df)
    ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)

```

### Problem 1
######  Assume that a stock's log returns at any time scale have normal distribution. 

+ Suppose that its average annual log return is 100%, and its annual standard deviation ("volatility") of log returns is 200%. 

What are its average (mu) and standard deviation (sigma) of daily log returns, assuming a year has 250 trading days? 

```{r, prob1, echo = T}

trading.days <- 250

annual.ret <- 1
annual.vol <- 2

mu <- annual.ret / trading.days
sigma <- annual.vol / sqrt(trading.days)

prob1 <- list(mu = round(mu, 5), sigma = round(sigma, 5))

```

_Average:_ __`r prob1$mu`__

_Standard Deviation:_ __`r prob1$sigma`__

### Problem 2
######  Simulate 250 instances of the daily log returns described in 1.) with random seed __set.seed(2015)__. 

+ Compute the net returns of these instances, and compute their average and standard deviation.

```{r, prob2, echo = T}

set.seed(2015)

logRet <- rnorm(250, mu, sigma)
netRet <- exp(logRet) - 1

m <- round(mean(netRet), 5)
s <- round(sd(netRet), 5)
  
```


_Average Net Return:_ __`r format(m, scientific = F)`__

_Standard Deviation of Net Returns:_ __`r format(s, scientific = F)`__

_Are the average (m) and standard deviation (s) of net returns same as the average and standard deviation of log returns computed in 1.)?_

__Answer:__ While not identical, they are close enough for practical purposes.

```{r, prob2_logret, echo = F}

p1 <- ggplot(data.table(ret = logRet), aes(ret)) +
  geom_histogram(aes(fill = ..count..), bins = 25) +
  ggtitle("Log Returns Distribution") +
  theme(plot.title = element_text(hjust = 0.5))

p2 <- ggplot(data.table(ret = netRet), aes(ret)) +
  geom_histogram(aes(fill = ..count..), bins = 25) +
  ggtitle("Net Returns Distribution") +
  theme(plot.title = element_text(hjust = 0.5))
  
grid.arrange(p1, p2, nrow = 2)

```

### Problem 3

+ Compute the quantity $m-\frac{s^2}{2}$.

```{r, prob3_a, echo = T}

prob3.a <- round(m - s^2/2, 5)

```

+ $m-\frac{s^2}{2}$ = __$`r format(prob3.a, scientific = F)`$__

_How does this compare with the average log return mu computed in part 1.)?_

__Answer:__ This is a close approximation to the original value of mu. We should note the extremely small sample size (250), and that a larger sample size (2.5m) produces a closer approximation:

```{r, prob3_b, echo = T}

set.seed(2015)

logRet <- rnorm(2500000, mu, sigma)
netRet <- exp(logRet) - 1

prob3.b <- round(mean(netRet) - sd(netRet)^2/2, 5)

```

__2.5m samples = $`r prob3.b`$__

Their equality can be proven analytically through a mathematical theorem called Ito's Lemma that lies at the foundation of Black-Scholes options pricing formula. 
Their numerical equality is not that good here because Ito's Lemma assumes we can divide a period into infinitesimally small sub-periods. 

So divide a year into 25,000 sub-periods (think of these sub-periods roughly as minutes) instead.

```{r, prob3_c, echo = T}

set.seed(2015)

trading.periods <- 25e3

min_from_days <- function(days) {
  60 * 6.5 * days
}

min.avg <- annual.ret / trading.periods
min.sd <- annual.vol / sqrt(trading.periods)

min.logRet <- rnorm( min_from_days(250), min.avg, min.sd)
min.netRet <- exp(min.logRet) - 1

new.m <- mean(min.netRet)
new.s <- sd(min.netRet)

new.mu <- mean(min.logRet)
new.sigma <- sd(min.logRet)

prob3.c <- round(new.m - new.s^2/2, 5)

```

Compare the new mu (average log return per minute) with the new $m-\frac{s^2}{2}$ (m is now the average net return per minute). 

+ New mu = $`r format(round(new.mu, 5 ), scientific=F)`$
+ New $m-\frac{s^2}{2}$ = $`r format(prob3.c, 5, scientific=F)`$

Also, compare the new sigma (standard deviation of log returns per minute) with the new s (standard deviation of net return per minute).

+ New sigma: __`r round(new.sigma, 5)`__
+ New s: __`r round(new.s, 5)`__

\newpage

### Problem 4

+ If we assume that the stock's initial price is $1, what is the expected value of its log price log(P(t)) after t minutes expressed in terms of *mu*?

From A9.4 we know that if P is lognormal($\mu$, $\sigma$), then $\mu$ is the expected value of log(P). Sampling for t periods, we have:

\begin{center}

$log(\overline{P}) \sim {\sf N}(\mu, \frac{\sigma^{2}}{t})$

Let $R \sim {\sf N}(\mu, \sigma^{2})$, be a return that is IID standard normal.

$\mathbb{E}$$P_t$ = exp($\sigma R_t + \mu$), where ${R_t}$ is IID standard normal.

Taking the log of both sides, we get:

$log(P_t)$ = $\sigma R_t + \mu$

Subtracting $\sigma R_t$ from both sides:

$\mu$ = $log(P_t) - \sigma R_t$

\end{center}

+ And what is the expected value of its price P(t) expressed in terms of *mu* and *sigma*? 

\begin{center}

From the previous problem, we have:

$\mu$ = $log(P_t) - \sigma R_t$

Multiply both sides by $\frac{1}{\sigma}$:

$\frac{\mu}{\sigma}$ = $log(P_t) - R_t$

\end{center}

+ Finally, express these expected values in terms of m and s instead.

### Problem 5

The continuously compounded rate of growth of a stock is log(P(t))/t. 

+ What is the expected continuously compounded rate of growth of the stock in part __4__?

\begin{center}

$$1 * \sum_{n=1}^{t} log(\frac{P_{n}}{P_{n-1}})$$

\end{center}


```{r, prob4_c, echo = T}

set.seed(2015)

initial.price <- 1

t <- 250

logRet = rnorm( min_from_days(t), new.mu, new.sigma) 
logPrice = c(initial.price, initial.price * cumsum(logRet))

ggplot(data.table(y = logPrice)[, x := .I], aes( x, y)) +
  geom_line(color = "cornflowerblue") +
  labs(title = "Log Stock Price P(t)", x = "Time", y = "Log Price") +
  theme(plot.title = element_text(hjust = 0.5))

```